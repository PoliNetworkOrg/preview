"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([["7256"],{2565:function(e,r,n){n.r(r),n.d(r,{default:()=>u,frontMatter:()=>s,metadata:()=>t,assets:()=>c,toc:()=>l,contentTitle:()=>a});var t=JSON.parse('{"id":"infrastructure/getting-started/cloud-infrastructure/Terraform","title":"Terraform","description":"Detailed overview of our Azure-based infrastructure managed via the polinetworkorg/terraform repository.","source":"@site/docs/infrastructure/02-getting-started/cloud-infrastructure/Terraform.md","sourceDirName":"infrastructure/02-getting-started/cloud-infrastructure","slug":"/infrastructure/getting-started/cloud-infrastructure/Terraform","permalink":"/preview/PoliNetworkOrg/docs/pr/30/docs/infrastructure/getting-started/cloud-infrastructure/Terraform","draft":false,"unlisted":false,"editUrl":"https://github.com/polinetworkorg/docs/tree/main/docs/infrastructure/02-getting-started/cloud-infrastructure/Terraform.md","tags":[],"version":"current","frontMatter":{"title":"Terraform","description":"Detailed overview of our Azure-based infrastructure managed via the polinetworkorg/terraform repository."},"sidebar":"infra","previous":{"title":"Cloud Infrastructure","permalink":"/preview/PoliNetworkOrg/docs/pr/30/docs/infrastructure/getting-started/cloud-infrastructure/"},"next":{"title":"Pipelines","permalink":"/preview/PoliNetworkOrg/docs/pr/30/docs/category/pipelines"}}'),o=n("6773"),i=n("6070");let s={title:"Terraform",description:"Detailed overview of our Azure-based infrastructure managed via the polinetworkorg/terraform repository."},a=void 0,c={},l=[{value:"What is Terraform?",id:"what-is-terraform",level:2},{value:"Why We Use Terraform",id:"why-we-use-terraform",level:3},{value:"How Terraform Works",id:"how-terraform-works",level:3},{value:"Terraform Code vs. Terraform State vs. Azure State",id:"terraform-code-vs-terraform-state-vs-azure-state",level:3},{value:"Terraform Implementation Overview",id:"terraform-implementation-overview",level:2},{value:"Repository Overview",id:"repository-overview",level:3},{value:"Infrastructure Structure",id:"infrastructure-structure",level:3},{value:"State Management",id:"state-management",level:3},{value:"Access and Authorization",id:"access-and-authorization",level:3},{value:"Funding and Nonprofit Considerations",id:"funding-and-nonprofit-considerations",level:3},{value:"Making Changes to the Infrastructure",id:"making-changes-to-the-infrastructure",level:2},{value:"Basic Workflow for Infrastructure Changes",id:"basic-workflow-for-infrastructure-changes",level:3},{value:"Basic Terraform CLI Commands",id:"basic-terraform-cli-commands",level:3},{value:"References",id:"references",level:2}];function d(e){let r={a:"a",admonition:"admonition",blockquote:"blockquote",br:"br",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.h2,{id:"what-is-terraform",children:"What is Terraform?"}),"\n",(0,o.jsx)(r.p,{children:"Terraform is an open-source Infrastructure as Code (IaC) tool developed by\nHashiCorp. It allows you to define, provision, and manage the infrastructure\nusing a declarative configuration language. This means you describe the desired\nstate of the infrastructure, and Terraform takes care of creating and updating\nthe resources to match that state."}),"\n",(0,o.jsxs)(r.admonition,{type:"important",children:[(0,o.jsxs)(r.p,{children:["This documentation assumes you already have the Terraform CLI installed on your\nlocal machine. If you need help setting up Terraform, please refer to the\n",(0,o.jsx)(r.a,{href:"https://learn.hashicorp.com/tutorials/terraform/install-cli",children:"official documentation"}),"."]}),(0,o.jsxs)(r.p,{children:["You'll also need to be logged in with the Azure CLI and have the necessary\npermissions to manage the resources in our Azure subscription (more on this\n",(0,o.jsx)(r.a,{href:"../setup#azure-cli--kubectl",children:"here"}),")."]}),(0,o.jsx)(r.p,{children:"Once you have logged in to the Azure CLI, you need to set the necessary\nenvironment variables by running this command at the root of the repository:"}),(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-sh",children:"source ./access_key.sh\n"})}),(0,o.jsxs)(r.p,{children:["More about this in the ",(0,o.jsx)(r.a,{href:"https://github.com/PoliNetworkOrg/terraform/?tab=readme-ov-file#notes",children:"repository README"}),"."]})]}),"\n",(0,o.jsx)(r.h3,{id:"why-we-use-terraform",children:"Why We Use Terraform"}),"\n",(0,o.jsx)(r.p,{children:"Our organization leverages Terraform to manage our Azure cloud infrastructure for several important reasons:"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Consistency:"})," Defining our infrastructure as code ensures that every environment is configured the same way, reducing the chance of human error."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Automation:"})," Terraform automates the provisioning and modification of resources, streamlining our deployment processes."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Version Control:"})," Storing Terraform configurations in version control systems allows us to track changes, collaborate effectively, and revert to previous versions if needed."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Modularity:"})," Terraform encourages breaking down the infrastructure into reusable modules, which simplifies management and enhances maintainability."]}),"\n"]}),"\n",(0,o.jsx)(r.h3,{id:"how-terraform-works",children:"How Terraform Works"}),"\n",(0,o.jsxs)(r.admonition,{type:"warning",children:[(0,o.jsxs)(r.p,{children:["To run terraform commands you need to have the right permissions and credentials.\nIf you are not sure about your permissions, please contact the IT department (but\nif you have to ask you probably shouldn't run ",(0,o.jsx)(r.code,{children:"apply"})," yourself anyway)."]}),(0,o.jsxs)(r.p,{children:["If you haven't yet set up the Azure CLI please refer to the ",(0,o.jsx)(r.a,{href:"../setup#azure-cli--kubectl",children:"setup guide"}),"."]})]}),"\n",(0,o.jsx)(r.p,{children:"Terraform operates through a simple yet powerful workflow:"}),"\n",(0,o.jsxs)(r.ol,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Write:"})," You define the infrastructure in configuration files (typically with a ",(0,o.jsx)(r.code,{children:".tf"})," extension)."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Plan:"})," Running ",(0,o.jsx)(r.code,{children:"terraform plan"})," generates an execution plan, showing you the changes Terraform will make to achieve the desired state."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Apply:"})," Executing ",(0,o.jsx)(r.code,{children:"terraform apply"})," implements the changes, creating or updating the infrastructure accordingly."]}),"\n"]}),"\n",(0,o.jsxs)(r.admonition,{type:"danger",children:[(0,o.jsx)(r.p,{children:"Running Terraform commands can modify the cloud infrastructure."}),(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"THIS CAN INCUR COSTS OR CAUSE DOWNTIME AND PERMANENT DATA LOSS IF NOT DONE PROPERLY."})}),(0,o.jsxs)(r.p,{children:["Always review the execution plan (",(0,o.jsx)(r.code,{children:"terraform plan"}),") before applying changes."]})]}),"\n",(0,o.jsx)(r.h3,{id:"terraform-code-vs-terraform-state-vs-azure-state",children:"Terraform Code vs. Terraform State vs. Azure State"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Terraform Code:"}),(0,o.jsx)(r.br,{}),"\n","This consists of the configuration files that describe your desired\ninfrastructure. These files are the blueprint for what you want the infrastructure to look like."]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Terraform State:"}),(0,o.jsx)(r.br,{}),"\n","The state file (which we named ",(0,o.jsx)(r.code,{children:"state.tfstate"}),") records the current state\nof the infrastructure as managed by Terraform. This file is critical because\nit maps your configuration to the real-world resources, tracks dependencies,\nand allows Terraform to detect what needs to change during updates. Our state\nfile is stored remotely (in an Azure Storage Account) and is locked using\nAzure's integrated leasing mechanism to prevent concurrent modifications."]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Azure State:"}),(0,o.jsx)(r.br,{}),"\n","This is the actual state of resources deployed in the Azure environment.\nWhile Terraform keeps track of these resources via its state file, the real\nconfiguration and runtime details exist within Azure. The Terraform state acts\nas an intermediary, ensuring that the desired state (from the Terraform code)\nand the actual state (in Azure) are in sync. If resources are modified directly\nin Azure without updating Terraform, discrepancies may occur, highlighting the\nimportance of using Terraform as the single source of truth."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:"This clear separation between code, Terraform state, and the actual cloud state\nis key to maintaining a reliable and predictable infrastructure."}),"\n",(0,o.jsx)(r.h2,{id:"terraform-implementation-overview",children:"Terraform Implementation Overview"}),"\n",(0,o.jsxs)(r.p,{children:["Welcome to the documentation for the ",(0,o.jsx)(r.strong,{children:"polinetworkorg/terraform"})," repository.\nThis page provides an in-depth look at our Terraform implementation on\n",(0,o.jsx)(r.strong,{children:"Microsoft Azure"}),", detailing the architecture of our infrastructure and the\nkey modules that make it up. While this overview highlights our main components,\nit\u2019s important to note that there are alternative approaches to similar problems,\nand our setup is tailored to our current needs."]}),"\n",(0,o.jsx)(r.h3,{id:"repository-overview",children:"Repository Overview"}),"\n",(0,o.jsxs)(r.p,{children:["The ",(0,o.jsx)(r.strong,{children:"polinetworkorg/terraform"})," repository is our centralized solution for\nprovisioning and managing cloud infrastructure on Azure. It follows a modular\ndesign that breaks down the overall architecture into focused components. To give\nyou a rough idea of what is in there, here are some of the primary modules:"]}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"aks:"})," Defines all resources related to our Azure Kubernetes Service (AKS) instance."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"mariadb:"})," Manages the main MariaDB database."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"monitoring:"})," Sets up our monitoring stack using Grafana and Prometheus."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"argocd:"})," Configures our ArgoCD installation for GitOps-driven deployments."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"storage:"})," Handles the Azure Storage Account where the Terraform state is stored."]}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:"There are also additional modules in the repository that handle specific\napplications or services, but these are not detailed in this general overview."}),"\n",(0,o.jsxs)(r.admonition,{type:"info",children:[(0,o.jsx)(r.p,{children:"While the choices made in this implementation reflect our specific requirements\nand constraints, it's worth noting that other approaches exist for managing\ncloud infrastructure with Terraform."}),(0,o.jsx)(r.p,{children:"Our modular design, state management strategy,\nand access controls are tailored to our current operational needs and funding\nsituation\u2014but they are not set in stone. Please feel free to reach out to the\nIT department if you have any questions or suggestions."})]}),"\n",(0,o.jsx)(r.h3,{id:"infrastructure-structure",children:"Infrastructure Structure"}),"\n",(0,o.jsx)(r.p,{children:"Our repository is organized to clearly separate concerns and promote reusability.\nWhile the exact folder structure may vary, a typical layout looks like this:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"\uD83D\uDCC1 polinetworkorg/terraform/\n \u251C\u2500 \uD83D\uDCC1 modules/             # All modules are kept in a dedicated directory\n \u2502   \u251C\u2500 \uD83D\uDCC1 aks/             # Module for Azure Kubernetes Service resources\n \u2502   \u251C\u2500 \uD83D\uDCC1 mariadb/         # Module for the main MariaDB database\n \u2502   \u251C\u2500 \uD83D\uDCC1 monitoring/      # Module for monitoring (Grafana + Prometheus)\n \u2502   \u251C\u2500 \uD83D\uDCC1 argocd/          # Module for ArgoCD installation\n \u2502   \u251C\u2500 \uD83D\uDCC1 storage/         # Module for Azure Storage Account where the state.tfstate is kept\n \u2502   \u2514\u2500 [other modules]     # Additional modules for specific services\n \u251C\u2500\u2500 main.tf                # Main Terraform configuration file\n \u251C\u2500\u2500 variables.tf           # Variables definition file\n \u251C\u2500\u2500 outputs.tf             # Outputs definition file\n \u251C\u2500\u2500 README.md              # General repository documentation\n \u2514\u2500\u2500 [other files]          \n"})}),"\n",(0,o.jsx)(r.h3,{id:"state-management",children:"State Management"}),"\n",(0,o.jsxs)(r.p,{children:["We use an ",(0,o.jsx)(r.strong,{children:"Azure Storage Account"})," for managing the Terraform state. The state\nfile (",(0,o.jsx)(r.code,{children:"state.tfstate"}),") is stored within a dedicated container named ",(0,o.jsx)(r.code,{children:"terraform-state"}),",\nas defined in our ",(0,o.jsx)(r.strong,{children:"storage"})," module. The integrated leasing mechanism provided\nby the Azure Storage Account is used for state locking, ensuring that concurrent\nTerraform operations do not conflict with each other."]}),"\n",(0,o.jsx)(r.h3,{id:"access-and-authorization",children:"Access and Authorization"}),"\n",(0,o.jsxs)(r.p,{children:["Given the critical nature of our infrastructure, modifications (e.g., running\n",(0,o.jsx)(r.code,{children:"terraform apply"}),") are restricted to personnel with sufficient clearance. As an\nassociation, any infrastructure changes require approval from either the Head of\nthe IT Department or the Directive Council. All authorization is managed through\n",(0,o.jsx)(r.strong,{children:"Microsoft's Entra ID system"}),", ensuring that only properly authenticated and\nauthorized users can perform these operations."]}),"\n",(0,o.jsx)(r.h3,{id:"funding-and-nonprofit-considerations",children:"Funding and Nonprofit Considerations"}),"\n",(0,o.jsxs)(r.p,{children:["As a nonprofit organization, we benefit from a ",(0,o.jsx)(r.strong,{children:"Microsoft Azure Grant for Nonprofits"}),",\nwhich provides us with a budget of ",(0,o.jsx)(r.strong,{children:"\u20AC2000 per year"}),". This support helps offset\nour cloud costs and underpins our commitment to maintaining a robust and scalable\ninfrastructure."]}),"\n",(0,o.jsxs)(r.admonition,{type:"info",children:[(0,o.jsx)(r.p,{children:"This is one of the core reasons we are structured as a nonprofit organization, and why\nwe use Azure as our cloud provider."}),(0,o.jsxs)(r.p,{children:["You can find more about our benefits ",(0,o.jsx)(r.a,{href:"https://www.microsoft.com/en-us/nonprofits/azure",children:"here"}),"."]}),(0,o.jsxs)(r.p,{children:["If you have access to the adminorg account, you can check the current status of\nour Azure grant ",(0,o.jsx)(r.a,{href:"https://www.microsoftazuresponsorships.com/",children:"here"}),"."]})]}),"\n",(0,o.jsx)(r.h2,{id:"making-changes-to-the-infrastructure",children:"Making Changes to the Infrastructure"}),"\n",(0,o.jsx)(r.p,{children:"This section provides a basic guide on how to update our infrastructure using\nTerraform and introduces some of the automated workflows that help us maintain\nconsistency and control."}),"\n",(0,o.jsx)(r.h3,{id:"basic-workflow-for-infrastructure-changes",children:"Basic Workflow for Infrastructure Changes"}),"\n",(0,o.jsxs)(r.ol,{children:["\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Edit the Terraform Code:"}),(0,o.jsx)(r.br,{}),"\n","Modify the relevant configuration files to define your desired changes in the\ninfrastructure."]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Review Your Changes Locally:"}),(0,o.jsx)(r.br,{}),"\n","Run ",(0,o.jsx)(r.code,{children:"terraform plan"})," to generate an execution plan. This command will show\nyou what changes will be made to align the actual infrastructure with your\ncode."]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Cost Estimation with Infracost:"}),(0,o.jsx)(r.br,{}),"\n","When you open a pull request, our ",(0,o.jsx)(r.strong,{children:"Infracost workflow"})," is triggered\nautomatically. This workflow calculates the estimated cost impact of your\nchanges and posts a report in the pull request comments, so you can review\nany potential cost implications before merging."]}),"\n",(0,o.jsx)(r.admonition,{type:"tip",children:(0,o.jsxs)(r.p,{children:["If you want to run Infracost locally, you can install it by following the\n",(0,o.jsx)(r.a,{href:"https://www.infracost.io/docs/",children:"official documentation"}),"."]})}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Apply the Changes:"}),(0,o.jsx)(r.br,{}),"\n","After your changes have been reviewed and approved, merge the pull request\nand run ",(0,o.jsx)(r.code,{children:"terraform apply"})," to implement the changes. This command updates the\nAzure resources to match the configuration defined in your code."]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Drift Detection:"}),(0,o.jsx)(r.br,{}),"\n","A nightly ",(0,o.jsx)(r.strong,{children:"Drift workflow"})," runs to detect any discrepancies between the\ncurrent Terraform state and the actual state in Azure. If this workflow\ndetects a drift from what the ",(0,o.jsx)(r.code,{children:"terraform plan"})," output would predict, it\nautomatically opens an issue for further investigation."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.h3,{id:"basic-terraform-cli-commands",children:"Basic Terraform CLI Commands"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:(0,o.jsx)(r.code,{children:"terraform init"})}),(0,o.jsx)(r.br,{}),"\n","Initializes the working directory containing the Terraform configuration files."]}),"\n",(0,o.jsx)(r.admonition,{type:"tip",children:(0,o.jsx)(r.p,{children:"This has to be run as soon as you clone the repository or when you pull changes\nthat include new modules or providers."})}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:(0,o.jsx)(r.code,{children:"terraform plan"})}),(0,o.jsx)(r.br,{}),"\n","Generates an execution plan showing what changes will be applied to the infrastructure."]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:(0,o.jsx)(r.code,{children:"terraform apply"})}),(0,o.jsx)(r.br,{}),"\n","Applies the changes defined in your Terraform configuration to the cloud environment."]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:(0,o.jsx)(r.code,{children:"terraform destroy"})}),(0,o.jsx)(r.br,{}),"\n","Destroys the resources managed by Terraform, useful for tearing down test environments or decommissioning infrastructure."]}),"\n",(0,o.jsxs)(r.admonition,{type:"danger",children:[(0,o.jsxs)(r.p,{children:["If you ever happen to be as much as tempted of using ",(0,o.jsx)(r.code,{children:"terraform destroy"}),", you\nbetter be ",(0,o.jsx)(r.strong,{children:"SURE AS SHIT"})," about what you are doing. Make sure to review the\nimplications thoroughly before proceeding."]}),(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.em,{children:"One does not simply destroy PoliNetwork with one command."})}),"\n"]})]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:"By following these steps and leveraging our automated workflows, you ensure that\ninfrastructure changes are managed in a consistent, cost-aware, and controlled\nmanner."}),"\n",(0,o.jsx)(r.h2,{id:"references",children:"References"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://www.terraform.io/docs/index.html",children:"Terraform Documentation"})}),"\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://docs.microsoft.com/en-us/azure/",children:"Microsoft Azure Documentation"})}),"\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://www.infracost.io/docs/",children:"Infracost Documentation"})}),"\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://github.com/polinetworkorg/terraform",children:"Terraform Repository"})}),"\n"]})]})}function u(e={}){let{wrapper:r}={...(0,i.a)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},6070:function(e,r,n){n.d(r,{Z:function(){return a},a:function(){return s}});var t=n(1699);let o={},i=t.createContext(o);function s(e){let r=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),t.createElement(i.Provider,{value:r},e.children)}}}]);